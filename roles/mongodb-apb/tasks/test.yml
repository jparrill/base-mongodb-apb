---
- name: "[MONGODB-APB][{{ mode | upper }}] Testing MongoDB Deployment"
  debug:
    msg:
      - "Test Execution:"
      - "  Mode: {{ mode }}"
      - "  State: {{ state }}"
      - "  Deployment Type: {{ deployment_type }}" 
      - "  Plan: {{ _apb_plan_id }}" 

- name: "[MONGODB-APB][{{ mode | upper }}] Sleeping"
  pause:
    seconds: 10

# Check that MongoDB don't fall down after some seconds
- name: "[MONGODB-APB][{{ mode | upper }}] Ensure that MongoDB is still ready"
  wait_for:
    port: 27017
    host: "{{ mongodb_svc.service.spec.cluster_ip }}"
    timeout: 300
  register: mongodb_conn
  when: state == "present"

- name: "[MONGODB-APB][{{ mode | upper }}] Saving Tests results on error"
  asb_save_test_result:
    fail: True
    msg: "Test Failed. Error connecting with MongoDB. Data - {{ mongodb_conn }}"
  when: mongodb_conn.failed | bool
